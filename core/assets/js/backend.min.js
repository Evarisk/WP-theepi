window.eoxiaJS.theEPI = {};

window.eoxiaJS.theEPI.core = {};

/**
 * Keep the button in memory.
 *
 * @type {Object}
 */
window.eoxiaJS.theEPI.core.currentButton;

/**
 * Keep the media frame in memory.
 * @type {Object}
 */
window.eoxiaJS.theEPI.core.mediaFrame;

/**
 * Keep the selected media in memory.
 * @type {Object}
 */
window.eoxiaJS.theEPI.core.selectedInfos = [];

window.eoxiaJS.theEPI.core.init = function() {
	window.eoxiaJS.theEPI.core.event();
};

window.eoxiaJS.theEPI.core.event = function() {
	jQuery( document ).on( 'click', '.wrap-theepi .create-mass-epi', window.eoxiaJS.theEPI.core.openMedia );
};

window.eoxiaJS.theEPI.core.openMedia = function( event ) {
	window.eoxiaJS.theEPI.core.currentButton = jQuery( this );
	event.preventDefault();

	window.eoxiaJS.theEPI.core.mediaFrame = new window.wp.media.view.MediaFrame.Post({}).open();
	window.eoxiaJS.theEPI.core.mediaFrame.on( 'insert', function() { window.eoxiaJS.theEPI.core.selectedFile(); } );
};

window.eoxiaJS.theEPI.core.selectedFile = function() {
	window.eoxiaJS.theEPI.core.mediaFrame.state().get( 'selection' ).map( function( attachment ) {
		window.eoxiaJS.theEPI.core.selectedInfos.push( attachment.id );
	} );

	var data = {
		action: 'create_mass_epi',
		files_id: window.eoxiaJS.theEPI.core.selectedInfos
	};

	window.eoxiaJS.loader.display( window.eoxiaJS.theEPI.core.currentButton );
	jQuery.post( window.ajaxurl, data, function( response ) {
		var epiView = jQuery( response );
		window.eoxiaJS.loader.remove( window.eoxiaJS.theEPI.core.currentButton );

		window.eoxiaJS.theEPI.core.currentButton = undefined;
		window.eoxiaJS.theEPI.core.selectedInfos = [];
		window.eoxiaJS.theEPI.core.mediaFrame = undefined;

		jQuery( '.wrap-theepi .wpeo-table.epi .table-row.table-header' ).after( epiView );
		setTimeout( function() {
			epiView.addClass( 'animate' );
		}, 100 );
	} );
};

/**
 * Initialise l'objet "audit" ainsi que la méthode "init" obligatoire pour la bibliothèque EoxiaJS.
 *
 * @since 0.5.0
 * @version 0.5.0
 */

window.eoxiaJS.theEPI.Audit = {};

window.eoxiaJS.theEPI.Audit.init = function() {
	window.eoxiaJS.theEPI.Audit.event();
};

window.eoxiaJS.theEPI.Audit.event = function() {
	jQuery( document ).on( 'click', '.modal-header .button-toggle', window.eoxiaJS.theEPI.Audit.buttonToggle );

};

window.eoxiaJS.theEPI.Audit.buttonToggle = function( event ) {

	var toggleON = jQuery( this ).hasClass( 'fa-toggle-on' );
	var nextStep = '';
	if (toggleON) {

		nextStep = 'KO';
		jQuery( this ).removeClass( "fa-toggle-on" ).addClass( "fa-toggle-off" );
		jQuery( this ).closest( '.modal-container' ).find( '.modal-footer' ).find( '.wpeo-button' ).attr('data-status-epi', 'KO' );
		jQuery( this ).closest( ".button-toggle-modal-headear" ).find( '.button-toggle-OK' ).attr({ 'style' : 'color : grey; font-weight : auto' });
		jQuery( this ).closest( ".button-toggle-modal-headear" ).find( '.button-toggle-KO' ).attr({ 'style' : 'color : black; font-weight : bold' });

	} else {

		nextStep = 'OK';
		jQuery( this ).removeClass( "fa-toggle-off" ).addClass( "fa-toggle-on" );
		jQuery( this ).closest( '.modal-container' ).find( '.modal-footer' ).find( '.wpeo-button' ).attr('data-status-epi', 'OK' );
		jQuery( this ).closest( ".button-toggle-modal-headear" ).find( '.button-toggle-OK' ).attr({ 'style' : 'color : black; font-weight : bold' });
		jQuery( this ).closest( ".button-toggle-modal-headear" ).find( '.button-toggle-KO' ).attr({ 'style' : 'color : grey; font-weight : auto' });

	}

	var id = jQuery( this ).closest( '.button-toggle-modal-headear' ).attr( 'data-id' );
	var action = jQuery( this ).closest( '.button-toggle-modal-headear' ).attr( 'data-action' );
	var nonce = jQuery( this ).closest( '.button-toggle-modal-headear' ).attr( 'data-nonce' );
	var data = {
		action: action,
		_wpnonce: nonce,
		id: id,
		next_step: nextStep
	};

	window.eoxiaJS.loader.display( jQuery( this ).closest( '.button-toggle-modal-headear' ) );
	window.eoxiaJS.request.send( jQuery( this ), data );

};

/**
 * Le callback en cas de réussite à la requête Ajax "create_task_audit".
 * Remplaces la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.5.0
 * @version 0.5.0
 */
window.eoxiaJS.theEPI.Audit.createdTaskAuditSuccess = function( triggeredElement, response ) {
	console.log( 'OK ');
	console.log( response.data.view  );
	var element = triggeredElement.closest( '.modal-container' ).find( '.modal-content' );
	var content = element.html();
	element.html( response.data.view + content );
};

/**
 * Le callback en cas de réussite à la requête Ajax "create_task_audit".
 * Remplaces la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.5.0
 * @version 0.5.0
 */
window.eoxiaJS.theEPI.Audit.ImportedTaskAuditSuccess = function( triggeredElement, response ) {
	console.log( 'OK ');
	console.log( response.data.view  );
	var element = triggeredElement.closest( '.wpeo-modal' );
	element .replaceWith( response.data.view );

};

/**
 * Le callback en cas de réussite à la requête Ajax "create_task_audit".
 * Remplaces la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.5.0
 * @version 0.5.0
 */
window.eoxiaJS.theEPI.Audit.ImportedButtonTaskAuditSuccess = function( triggeredElement, response ) {
	var header = triggeredElement.closest( '.wpeo-modal' ).find( '.modal-header' ).find('.modal-title-header');
	header.html( response.data.modal_title );
	var content = triggeredElement.closest( '.wpeo-modal' ).find( '.modal-content' );
	content.html( response.data.view );
	var footer = triggeredElement.closest( '.wpeo-modal' ).find( '.modal-footer' );
	footer.html( response.data.buttons_view);

};

window.eoxiaJS.theEPI.Audit.ControlEPISuccess = function( triggeredElement, response ) {
	triggeredElement.closest( '.epi-row' ).find( '.control_audit' ).html( response.data.view_item );
	triggeredElement.parent().append( response.data.modal_template );
};

window.eoxiaJS.theEPI.Audit.DisplayControlEPISuccess = function( triggeredElement, response ) {
	triggeredElement.parent().append( response.data.modal_template );
};







/**
 * Le callback en cas de réussite à la requête Ajax "create_task_audit".
 * Remplaces la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.5.0
 * @version 0.5.0
 */
window.eoxiaJS.theEPI.Audit.ValidAuditSuccess = function( triggeredElement, response ) {
	jQuery( '.wrap .container-content .epi .epi-row[ data-id="' + response.data.id + '"]' ).replaceWith( response.data.view );
};

window.eoxiaJS.theEPI.Audit.GetContentFromUrlAuditSuccess = function( triggeredElement, response ){
    if( response.data.content != "" ){
        triggeredElement.closest( '.modal-content' ).find( 'textarea[ name="content"]' ).html( response.data.content );
    }
}

window.eoxiaJS.theEPI.Audit.DisplayAllAuditSuccess = function( triggeredElement, response ) {
	var toggleChevron = triggeredElement.find( '.icon' ).hasClass( 'fa-chevron-right' );

	if (toggleChevron) {
		triggeredElement.closest( '.control_audit').html( response.data.view ).find( '.icon' ).removeClass( "fa-chevron-right" ).addClass( "fa-chevron-down" );
		triggeredElement.closest( '.control_audit').html( response.data.view );
	} else {
		triggeredElement.closest( '.control_audit').html( response.data.view ).find( '.icon' ).removeClass( "fa-chevron-down" ).addClass( "fa-chevron-right" );
		jQuery( '.wrap .container-content .epi .epi-row[ data-id="' + response.data.id + '"]' ).find( '.control_audit').html( response.data.single_view_audit );

	}
};

/**
 * Initialise l'objet "EPI" ainsi que la méthode "init" obligatoire pour la bibliothèque EoxiaJS.
 *
 * @since 0.1.0
 * @version 0.4.0
 */
window.eoxiaJS.theEPI.EPI = {};

window.eoxiaJS.theEPI.EPI.init = function() {
	window.eoxiaJS.theEPI.EPI.event();
};

window.eoxiaJS.theEPI.EPI.event = function() {
	jQuery( document ).on( 'keyup', '.wrap-theepi .wpeo-table.epi .epi-row input[name="periodicity"]', window.eoxiaJS.theEPI.EPI.activeSaveButton );
	jQuery( document ).on( 'click', '.wrap-theepi .scroll-top', window.eoxiaJS.theEPI.EPI.scrollTop );
	jQuery( document ).on( 'click', '.wrap-theepi .wpeo-table .edit .button-save-epi', window.eoxiaJS.theEPI.EPI.saveEPIAjax );
	jQuery( document ).on( 'click', '.wrap-theepi .wpeo-tab.epi .tab-redirect .tab-element', window.eoxiaJS.theEPI.EPI.tabRedirect );

	jQuery( document ).on( 'click', '.wrap-theepi .action-request-edit-epi', window.eoxiaJS.theEPI.EPI.requestEpiEdit );


};

/**
 * Vérifie si le format du champ est bien numérique.
 * Si c'est le cas:
 * -Et que la popover est ouverte, la supprimes.
 * -Et rend le bouton ".add" active.
 *
 * @since 0.1.0
 * @version 0.4.0
 *
 * @param  {KeyboardEvent} event L'état du clavier.
 * @return {void}
 */
window.eoxiaJS.theEPI.EPI.activeSaveButton = function( event ) {
	jQuery( this ).closest( '.epi-row' ).find( '.action-input.add' ).addClass( 'button-disabled' );

	if ( Number.isInteger( parseInt( jQuery( this ).val() ) ) ) {
		jQuery( this ).closest( '.epi-row' ).find( '.action-input.add' ).removeClass( 'button-disabled' );
		window.eoxiaJS.popover.remove( jQuery( this ).closest( '.epi-row' ).find( 'input.wpeo-popover-event' ) );
	}
};

/**
 * Remontes tout en haut de la page.
 *
 * @since 0.4.0
 * @version 0.4.0
 *
 * @param  {ClickEvent} event L'état du clavier.
 * @return {void}
 */
window.eoxiaJS.theEPI.EPI.scrollTop = function( event ) {
	jQuery( 'html, body' ).animate( {
		scrollTop: jQuery( '.wrap-theepi' ).offset().top
	}, 500);
};

/**
 * Le callback en cas de réussite à la requête Ajax "create_epi".
 * Remplaces le contenu de <tbody> du tableau "epi".
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.5.0
 */
window.eoxiaJS.theEPI.EPI.CreatedEpiSuccess = function( triggeredElement, response ) {

	jQuery( '.wpeo-table.epi .epi-row.edit[data-id="' + response.data.close_epi_id + '"]' ).replaceWith( response.data.view_close );
	jQuery( '.wpeo-table.epi .epi-row.service[data-id="' + response.data.close_epi_id + '"]' ).remove();
	jQuery( '.wpeo-table.epi .tab-container' ).prepend( response.data.view_edit_epi );
	jQuery( '.wpeo-table.epi .table-row.epi-row.edit' ).after( response.data.view_edit_service );

};

/**
 * Le callback en cas de réussite à la requête Ajax "load_epi".
 * Remplaces la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.4.0
 */
window.eoxiaJS.theEPI.EPI.loadedEpiSuccess = function( triggeredElement, response ) {
	triggeredElement.closest( '.table-row' ).replaceWith( response.data.template );
};


/**
 * Le callback en cas de réussite à la requête Ajax "load_epi".
 * Remplaces la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.4.0
 */
window.eoxiaJS.theEPI.EPI.savedEpiSuccess = function( triggeredElement, response ) {
	triggeredElement.closest( '.table-row' ).replaceWith( response.data.view );
	jQuery( '.wpeo-table.epi .epi-row.service' ).remove();
};

/**
 * Le callback en cas de réussite à la requête Ajax "load_epi".
 * Remplaces la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.4.0
 */
window.eoxiaJS.theEPI.EPI.savedEpiError = function( triggeredElement, response ) {
	var parent_element = triggeredElement.closest( '.wpeo-table' ).find( '.service' );
	for ( i = 0; i < response.data.error.element.length; ++i ) {
		var input_element = parent_element.find( '.form-field[name="' + response.data.error.element[i] + '"]');
		/*window.eoxiaJS.popover.remove( input_element.find( '.wpeo-popover-event' ) );
		console.log( 	window.eoxiaJS.popover.remove( input_element.find( '.wpeo-popover-event' ) ) );
		input_element.attr( 'aria-label' , response.data.error.error[i] );
		window.eoxiaJS.popover.toggle( input_element.find( '.wpeo-popover-event' ) );*/
		input_element.closest( '.form-element' ).find( '.error' ).html( response.data.error.error[i] );

	}
	//window.eoxiaJS.popover.remove( input_element.find( '.wpeo-popover-event' ) );
};


/**
 * Le callback en cas de réussite à la requête Ajax "delete_epi".
 * Supprimes la ligne courante du tableau "epi"
 * Supprimes la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.4.0
 */
window.eoxiaJS.theEPI.EPI.deletedEpiSuccess = function( triggeredElement, response ) {
	triggeredElement.closest( '.table-row' ).fadeOut();
};

/**
 * Le callback en cas de réussite à la requête Ajax "edit_epi".
 * Edition d'un "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.5.0
 */
window.eoxiaJS.theEPI.EPI.editedEpiSuccess = function( triggeredElement, response ) {
	triggeredElement.closest( '.tab-container').find( '.epi-row.service' ).remove();

	if( response.data.close_epi_id == 0 ){
		triggeredElement.closest( '.wrap-theepi' ).find( '.wpeo-table.epi .epi-row[data-id="0"]' ).remove();
	}else{
		triggeredElement.closest( '.wrap-theepi' ).find( '.wpeo-table.epi .epi-row[data-id="' + response.data.close_epi_id + '"]' ).replaceWith( response.data.view_close );
	}

	triggeredElement.closest( '.epi-row' ).after( response.data.view_edit_service );
	triggeredElement.closest( '.epi-row' ).before( response.data.view_edit_epi );
	triggeredElement.closest( '.epi-row' ).remove();
};

/**
 * Le callback en cas de réussite à la requête Ajax "cancel_edit_epi".
 * Annule le mode édition d'un "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.5.0
 */
window.eoxiaJS.theEPI.EPI.canceledEditEpiSuccess = function( triggeredElement, response ) {
	triggeredElement.closest('.wpeo-table').find('.service').remove();
	triggeredElement.closest( '.epi-row' ).replaceWith( response.data.view );
};

/**
 * Le callback en cas de réussite à la requête Ajax "load_more_epi".
 * Ajoutes des entrées à la fin du <tbody> du tableau .wpeo-table.epi.
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.4.0
 * @version 0.4.0
 */
window.eoxiaJS.theEPI.EPI.loadedMoreEPISuccess = function( triggeredElement, response ) {
	var element   = jQuery( response.data.view );
	var countMore = response.data.count_more ? response.data.count_more : parseInt( jQuery( '#epi_per_page' ).val() );

	jQuery( '.wrap-theepi .wpeo-table.epi tbody' ).append( element );

	window.eoxiaJS.theEPI.EPI.refreshTextLoadMore( countMore, 0 );

	setTimeout( function() {
		element.addClass( 'fadeInUp animate-on' );

		jQuery( 'html, body' ).animate( {
			scrollTop: jQuery( '.epi-load-more' ).offset().top
		}, 1000 );
	}, 10 )
};

/**
 * Le callback en cas de réussite à la requête Ajax "search_epi".
 * Remplaces tout le tableau avec la bouton "load_more".
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.4.0
 * @version 0.4.0
 */
window.eoxiaJS.theEPI.EPI.searchedEPISuccess = function( triggeredElement, response ) {
	jQuery( '.wrap-theepi .container-content' ).html( response.data.view );

	if ( ! response.data.clear ) {
		jQuery( '.wrap-theepi .box-search .action-attribute' ).removeClass( 'button-disable' );
		jQuery( '.wrap-theepi .epi-load-more' ).attr( 'data-term', jQuery( '.wrap-theepi .box-search input[type="text"]' ).val() );
	} else {
		jQuery( '.wrap-theepi .box-search input[type="text"]' ).val( '' );
		jQuery( '.wrap-theepi .box-search .action-attribute' ).addClass( 'button-disable' );
		jQuery( '.wrap-theepi .epi-load-more' ).attr( 'data-term', '' );
	}
};



/**
 * Met à jour l'affichage du bouton "Load More" en bas de la page.
 *
 * @since 0.4.0
 * @version 0.4.0
 *
 * @param  {number} addNumberEPI      Le nombre d'EPI affiché dans le tableau.
 * @param  {number} addTotalNumberEPI Le nombre total d'EPI dans la base de donnée.
 *
 * @return {void}
 */
window.eoxiaJS.theEPI.EPI.refreshTextLoadMore = function( addNumberEPI, addTotalNumberEPI ) {
	var currentOffset =  currentNumberEPI = totalNumberEPI = 0;

	currentNumberEPI  = parseInt( jQuery( '.wrap-theepi .epi-load-more .number-epi' ).text() );
	currentNumberEPI += addNumberEPI;

	totalNumberEPI  = parseInt( jQuery( '.wrap-theepi .epi-load-more .total-number-epi' ).text() );
	totalNumberEPI += addTotalNumberEPI;

	if ( currentNumberEPI >= totalNumberEPI ) {
		currentNumberEPI = totalNumberEPI;
		jQuery( '.wrap-theepi .epi-load-more' ).addClass( 'button-disable' );
	} else {
		jQuery( '.wrap-theepi .epi-load-more' ).removeClass( 'button-disable' );
	}

	jQuery( '.wrap-theepi .epi-load-more .number-epi' ).text( currentNumberEPI );


	jQuery( '.wrap-theepi .epi-load-more .total-number-epi' ).text( totalNumberEPI );

	currentOffset = parseInt( jQuery( '.wrap-theepi .epi-load-more' ).attr( 'data-offset' ) );
	currentOffset += addNumberEPI;
	jQuery( '.wrap-theepi .epi-load-more' ).attr( 'data-offset', currentOffset );

};

window.eoxiaJS.theEPI.EPI.exportedEPISuccess = function ( triggeredElement, response ) {
	/*var element = document.createElement('a');
	console.log( response.data );
  element.setAttribute('href', response.data.link );
  element.setAttribute('download', response.data.filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);*/


	/*fetch(response.data.link)
  .then(resp => resp.blob())
  .then(blob => {
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    // the filename you want
    a.download = response.data.filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    alert('your file has downloaded!'); // or you know, something with better UX...
  })
  .catch(() => alert('oh no!'));*/

};


window.eoxiaJS.theEPI.EPI.saveEPIAjax = function ( event ) {
	var id = jQuery( this ).attr( 'data-id' );
	var fieldset_element    = jQuery( this ).closest( '.wpeo-table' ).find( '.service[ data-id="' + id + '"]' );
	var action              = jQuery( this ).attr( 'data-action' );
	var nonce               = jQuery( this ).attr( 'data-nonce' );

	var title               = jQuery( this ).closest( '.table-row' ).find( '.form-field[name="title"]' ).val();
	var serial_number       = jQuery( this ).closest( '.table-row' ).find( '.form-field[name="serial_number"]' ).val();
	var commissioning_date  = jQuery( this ).closest( '.table-row' ).find( '.form-field[name="commissioning-date"]' ).val();

	var maker               = fieldset_element.find( '.form-field[name="maker"]' ).val();
	var seller              = fieldset_element.find( '.form-field[name="seller"]' ).val();
	var manager             = fieldset_element.find( '.form-field[name="manager"]' ).val();
	var reference           = fieldset_element.find( '.form-field[name="reference"]' ).val();
	var lifetime            = fieldset_element.find( '.form-field[name="lifetime"]' ).val();
	var periodicity         = fieldset_element.find( '.form-field[name="periodicity"]' ).val();
	var manufacture_date    = fieldset_element.find( '.form-field[name="manufacture-date"]' ).val();
	var purchase_date       = fieldset_element.find( '.form-field[name="purchase-date"]' ).val();
	var control_date        = fieldset_element.find( '.form-label[name="control-date"]' ).attr( 'value' );
	var end_life_date       = fieldset_element.find( '.form-label[name="end-life-date"]' ).attr( 'value' );
	var disposal_date       = fieldset_element.find( '.form-label[name="disposal-date"]' ).attr( 'value' );


	var data = {
		action: action,
		_wpnonce: nonce,
		id: id,

		title: title,
		serial_number: serial_number,
		commissioning_date: commissioning_date,

		maker: maker,
		seller: seller,
		manager: manager,
		reference: reference,
		lifetime: lifetime,
		periodicity: periodicity,
		manufacture_date: manufacture_date,
		purchase_date: purchase_date,
		control_date: control_date,
		end_life_date: end_life_date,
		disposal_date: disposal_date

	};

//	var data_valid = window.eoxiaJS.theEPI.EPI.checkData( data ) ;
	//if ( data_valid[ 'success' ] ) {
		console.log(data);
		window.eoxiaJS.loader.display( jQuery( this ).closest( '.table-row' ) );
		window.eoxiaJS.request.send( jQuery( this ), data );
/*	}else {
		alert('ok');
	}*/
}

/**
 * Vérifie si le champ période de controle est bien un nombre pour continuer le formulaire d'ajout d'un EPI.
 *
 * @param  {HTMLDivElement} element Le bouton pour ajouter un EPI
 * @return {boolean}
 *
 * @since 0.1.0
 * @version 0.4.0
 */
window.eoxiaJS.theEPI.EPI.checkData = function( data ) {
	/*window.eoxiaJS.popover.remove( element.closest( '.epi-row' ).find( 'input.wpeo-popover-event' ) );

	if ( isNaN( element.closest( '.epi-row' ).find( 'input[name="periodicity"]' ).val() ) || '' == element.closest( '.epi-row' ).find( 'input[name="periodicity"]' ).val() ||
		( element.closest( '.epi-row' ).find( 'input[name="periodicity"]' ).val() && '0' == element.closest( '.epi-row' ).find( 'input[name="periodicity"]' ).val() ) ) {
		window.eoxiaJS.popover.toggle( element.closest( '.epi-row' ).find( 'input.wpeo-popover-event' ) );
		return false;
	}

	window.eoxiaJS.popover.remove( element.closest( '.epi-row' ).find( 'input.wpeo-popover-event' ) );

	return true;*/
/*	var data_return = {};
	data_return.success = true;
	data_return.error = "";
	console.log(data.purchase_date);

	if( data.purchase_date == "" || Date.parse(test)/1000 <=  Date.parse(data.manufacture_date)/1000 ) {
		console.log((Date.parse(test)/1000 ));
		data_return.success = false;
		data_return.error = "Purchase date not valid";
	}


	return data_return;*/
};

window.eoxiaJS.theEPI.EPI.tabRedirect = function( event ){
    var url = jQuery( this ).attr( 'data-url' );
    window.location.href = url;
}

window.eoxiaJS.theEPI.EPI.checkEditMode = function( triggeredElement ){
	var element = triggeredElement.closest( '.wrap-theepi' ).find( '.wpeo-table.epi' );
  var text = triggeredElement.attr( 'data-message' );
	if ( element.find( '.tab-container').find( '.table-row.epi-row.edit' ).length > 0 ) {
		if( confirm( text ) ){
			var id = element.find( '.tab-container').find( '.table-row.epi-row.edit' ).attr( 'data-id' );
			return id;
		}else{
			return -1;
		}
	}
	return 0;
}

window.eoxiaJS.theEPI.EPI.requestEpiEdit = function( event ){
	var id = window.eoxiaJS.theEPI.EPI.checkEditMode( jQuery( this ) );

	if( id != -1 ){

		var data = {};
		data.id = jQuery( this ).attr( 'data-id' );
		data.action = jQuery( this ).attr( 'data-action' );
		data._wpnonce = jQuery( this ).attr( 'data-nonce' );
		data.closeepi = id;

		window.eoxiaJS.loader.display( jQuery( this ) );
		window.eoxiaJS.request.send( jQuery( this ), data );
	}
}

/**
 * Initialise l'objet "setting" ainsi que la méthode "init" obligatoire pour la bibliothèque EoxiaJS.
 *
 * @since 0.2.0
 * @version 0.3.0
 */
window.eoxiaJS.theEPI.setting = {};

window.eoxiaJS.theEPI.setting.init = function() {
	window.eoxiaJS.theEPI.setting.event();
};

window.eoxiaJS.theEPI.setting.event = function() {
	jQuery( document ).on( 'click', '.settings_page_theepi-setting .list-users .wp-digi-pagination a', window.eoxiaJS.theEPI.setting.pagination );
	jQuery( document ).on( 'click', '.wpeo-tab.setting .tab-redirect .tab-element', window.eoxiaJS.theEPI.EPI.tabRedirect );
};

/**
 * Changes d'onglet lors du clic.
 *
 * @since 0.3.0
 * @version 0.3.0
 *
 * @param  {ClickEvent} event L'état de la souris lors du clic.
 * @return {void}
 */

window.eoxiaJS.theEPI.EPI.tabRedirect = function( event ){
    var url = jQuery( this ).attr( 'data-url' );
    window.location.href = url;
}

/**
 * Gestion de la pagination des utilisateurs.
 *
 * @since 0.2.0
 * @version 0.2.0
 *
 * @param  {ClickEvent} event [description]
 * @return {void}
 */
window.eoxiaJS.theEPI.setting.pagination = function( event ) {
	var href = jQuery( this ).attr( 'href' ).split( '&' );
	var nextPage = href[1].replace( 'current_page=', '' );

	jQuery( '.list-users' ).addClass( 'loading' );

	var data = {
		action: 'paginate_setting_theepi_page_user',
		next_page: nextPage
	};

	event.preventDefault();

	jQuery.post( window.ajaxurl, data, function( view ) {
		jQuery( '.list-users' ).replaceWith( view );
		window.eoxiaJS.digirisk.search.renderChanged();
	} );
};

/**
 * Le callback en cas de réussite à la requête Ajax "save_capacity".
 * Affiches le message de "success".
 *
 * @since 0.2.0
 * @version 0.2.0
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 */
window.eoxiaJS.theEPI.setting.savedCapability = function( triggeredElement, response ) {
};

/**
 * Le callback en cas de réussite à la requête Ajax "save_default_data".
 * Affiches le message de "success".
 *
 * @since 0.3.0
 * @version 0.3.0
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 */
window.eoxiaJS.theEPI.setting.savedDefaultData = function( triggeredElement, response ) {
	triggeredElement.addClass( 'button-success' );
	setTimeout( function() {
		triggeredElement.removeClass( 'button-success' );
	}, 1000 );
};

/**
 * Le callback en cas de réussite à la requête Ajax "save_date_management".
 * Affiches le message de "success".
 *
 * @since 0.5.0
 * @version 0.5.0
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 */
window.eoxiaJS.theEPI.setting.savedDateManagement = function( triggeredElement, response ) {
	triggeredElement.addClass( 'button-success' );
	setTimeout( function() {
		triggeredElement.removeClass( 'button-success' );
	}, 1000 );
};
