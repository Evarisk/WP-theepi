window.eoxiaJS.theEPI = {};

window.eoxiaJS.theEPI.core = {};

/**
 * Keep the button in memory.
 *
 * @type {Object}
 */
window.eoxiaJS.theEPI.core.currentButton;

/**
 * Keep the media frame in memory.
 * @type {Object}
 */
window.eoxiaJS.theEPI.core.mediaFrame;

/**
 * Keep the selected media in memory.
 * @type {Object}
 */
window.eoxiaJS.theEPI.core.selectedInfos = [];

window.eoxiaJS.theEPI.core.init = function() {
	window.eoxiaJS.theEPI.core.event();
};

window.eoxiaJS.theEPI.core.event = function() {
	jQuery( document ).on( 'click', '.digirisk-epi .create-mass-epi', window.eoxiaJS.theEPI.core.openMedia );
};

window.eoxiaJS.theEPI.core.openMedia = function( event ) {
	window.eoxiaJS.theEPI.core.currentButton = jQuery( this );
	event.preventDefault();

	window.eoxiaJS.theEPI.core.mediaFrame = new window.wp.media.view.MediaFrame.Post({}).open();
	window.eoxiaJS.theEPI.core.mediaFrame.on( 'insert', function() { window.eoxiaJS.theEPI.core.selectedFile(); } );
};

window.eoxiaJS.theEPI.core.selectedFile = function() {
	window.eoxiaJS.theEPI.core.mediaFrame.state().get( 'selection' ).map( function( attachment ) {
		window.eoxiaJS.theEPI.core.selectedInfos.push( attachment.id );
	} );

	var data = {
		action: 'create_mass_epi',
		files_id: window.eoxiaJS.theEPI.core.selectedInfos
	};

	window.eoxiaJS.theEPI.core.currentButton.addClass( 'loading' );
	jQuery.post( window.ajaxurl, data, function( response ) {
		window.eoxiaJS.theEPI.core.currentButton.removeClass( 'loading' );

		window.eoxiaJS.theEPI.core.currentButton = undefined;
		window.eoxiaJS.theEPI.core.selectedInfos = [];
		window.eoxiaJS.theEPI.core.mediaFrame = undefined;

		jQuery( '.digirisk-epi table tbody' ).html( response );
	} );
};

/**
 * Initialise l'objet "EPI" ainsi que la méthode "init" obligatoire pour la bibliothèque EoxiaJS.
 *
 * @since 0.1.0
 * @version 0.2.0
 */
window.eoxiaJS.theEPI.EPI = {};

window.eoxiaJS.theEPI.EPI.init = function() {
	window.eoxiaJS.theEPI.EPI.event();
};

window.eoxiaJS.theEPI.EPI.event = function() {
	jQuery( document ).on( 'keyup', '.table.epi .epi-row input[name="frequency_control"]', window.eoxiaJS.theEPI.EPI.activeSaveButton );

	jQuery( document ).on( 'click', '.digirisk-epi .wp-digi-pagination a', window.eoxiaJS.theEPI.EPI.pagination );
};

/**
 * Vérifie si le format du champ est bien numérique.
 * Si c'est le cas, rend le bouton "+" active.
 *
 * @since 0.1.0
 * @version 0.1.0
 *
 * @param  {KeyboardEvent} event L'état du clavier.
 * @return {void}
 */
window.eoxiaJS.theEPI.EPI.activeSaveButton = function( event ) {
	jQuery( this ).closest( '.epi-row' ).find( '.action-input.add' ).removeClass( 'blue' ).addClass( 'disable' );

	if ( Number.isInteger( parseInt( jQuery( this ).val() ) ) ) {
		jQuery( this ).closest( '.epi-row' ).find( '.action-input.add' ).removeClass( 'disable' ).addClass( 'blue' );
	}
};

/**
 * Gestion de la pagination des EPI.
 *
 * @param  {ClickEvent} event [description]
 * @return {void}
 *
 * @since 0.2.0
 * @version 0.2.0
 */
window.eoxiaJS.theEPI.EPI.pagination = function( event ) {
	var href = jQuery( this ).attr( 'href' ).split( '&' );
	var currentPage = href[1].replace( 'current_page=', '' );

	window.eoxiaJS.loader.display( jQuery( '.digirisk-epi' ) );

	var data = {
		action: 'paginate_epi',
		current_page: currentPage
	};

	event.preventDefault();

	jQuery.post( window.ajaxurl, data, function( view ) {
		window.eoxiaJS.loader.remove( jQuery( '.digirisk-epi' ) );
		jQuery( '.digirisk-epi .container-content' ).html( view );
	} );
};


/**
 * Le callback en cas de réussite à la requête Ajax "save_epi".
 * Remplaces le contenu de <tbody> du tableau "epi".
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.1.0
 */
window.eoxiaJS.theEPI.EPI.savedEpiSuccess = function( element, response ) {
  jQuery( '.digirisk-wrap' ).replaceWith( response.data.template );
};

/**
 * Le callback en cas de réussite à la requête Ajax "load_epi".
 * Remplaces la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.1.0
 */
window.eoxiaJS.theEPI.EPI.loadedEpiSuccess = function( element, response ) {
  jQuery( element ).closest( 'tr' ).replaceWith( response.data.template );
};

/**
 * Le callback en cas de réussite à la requête Ajax "delete_epi".
 * Supprimes la ligne courante du tableau "epi"
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 *
 * @since 0.1.0
 * @version 0.1.0
 */
window.eoxiaJS.theEPI.EPI.deletedEpiSuccess = function( element, response ) {
  jQuery( element ).closest( 'tr' ).fadeOut();
};

/**
 * Vérifie si le champ période de controle est bien un nombre pour continuer le formulaire d'ajout d'un EPI.
 *
 * @param  {HTMLDivElement} element Le bouton pour ajouter un EPI
 * @return {boolean}
 *
 * @since 0.1.0
 * @version 0.1.0
 */
window.eoxiaJS.theEPI.EPI.checkData = function( element ) {
	if ( isNaN( jQuery( element ).closest( '.epi-row' ).find( 'input[name="frequency_control"]' ).val() ) || '' == jQuery( element ).closest( '.epi-row' ).find( 'input[name="frequency_control"]' ).val() ) {
		jQuery( element ).closest( '.epi-row' ).find( 'td.tooltip' ).addClass( 'active' );
		return false;
	}

	jQuery( element ).closest( '.epi-row' ).find( 'td.tooltip.active' ).removeClass( 'active' );

	return true;
};

/**
 * Initialise l'objet "setting" ainsi que la méthode "init" obligatoire pour la bibliothèque EoxiaJS.
 *
 * @since 0.2.0
 * @version 0.3.0
 */
window.eoxiaJS.theEPI.setting = {};

window.eoxiaJS.theEPI.setting.init = function() {
	window.eoxiaJS.theEPI.setting.event();
};

window.eoxiaJS.theEPI.setting.event = function() {
	jQuery( document ).on( 'click', '.digi-tools-main-container .nav-tab', window.eoxiaJS.theEPI.setting.tabSwitcher );

	jQuery( document ).on( 'click', '.settings_page_theepi-setting .list-users .wp-digi-pagination a', window.eoxiaJS.theEPI.setting.pagination );
};

/**
 * Changes d'onglet lors du clic.
 *
 * @since 0.3.0
 * @version 0.3.0
 *
 * @param  {ClickEvent} event L'état de la souris lors du clic.
 * @return {void}
 */
window.eoxiaJS.theEPI.setting.tabSwitcher = function( event ) {
	event.preventDefault();

	jQuery( this ).closest( "h2" ).children( ".nav-tab" ).each( function() {
		jQuery( this ).removeClass( "nav-tab-active" );
	} );

	jQuery( this ).addClass( "nav-tab-active" );

	jQuery( this ).closest( ".digi-tools-main-container" ).find( ".tab-content" ).each( function() {
	 	jQuery( this ).hide();
	} );

	jQuery( "#" + jQuery( this ).attr( "data-id" ) ).show();
},

/**
 * Gestion de la pagination des utilisateurs.
 *
 * @since 0.2.0
 * @version 0.2.0
 *
 * @param  {ClickEvent} event [description]
 * @return {void}
 */
window.eoxiaJS.theEPI.setting.pagination = function( event ) {
	var href = jQuery( this ).attr( 'href' ).split( '&' );
	var nextPage = href[1].replace( 'current_page=', '' );

	jQuery( '.list-users' ).addClass( 'loading' );

	var data = {
		action: 'paginate_setting_theepi_page_user',
		next_page: nextPage
	};

	event.preventDefault();

	jQuery.post( window.ajaxurl, data, function( view ) {
		jQuery( '.list-users' ).replaceWith( view );
		window.eoxiaJS.digirisk.search.renderChanged();
	} );
};

/**
 * Le callback en cas de réussite à la requête Ajax "save_capacity".
 * Affiches le message de "success".
 *
 * @since 0.2.0
 * @version 0.2.0
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 */
window.eoxiaJS.theEPI.setting.savedCapability = function( triggeredElement, response ) {
};

/**
 * Le callback en cas de réussite à la requête Ajax "save_default_data".
 * Affiches le message de "success".
 *
 * @since 0.3.0
 * @version 0.3.0
 *
 * @param  {HTMLDivElement} triggeredElement  L'élement HTML déclenchant la requête Ajax.
 * @param  {Object}         response          Les données renvoyées par la requête Ajax.
 * @return {void}
 */
window.eoxiaJS.theEPI.setting.savedDefaultData = function( triggeredElement, response ) {
	triggeredElement.addClass( 'button-success' );
	setTimeout( function() {
		triggeredElement.removeClass( 'button-success' );
	}, 1000 );
};
